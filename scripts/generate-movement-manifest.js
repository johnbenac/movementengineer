#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

const MOVEMENTS_DIR = path.join(__dirname, '..', 'movements');
const OUTPUT_FILE = path.join(MOVEMENTS_DIR, 'manifest.js');

function collectDatasetFiles(dirPath) {
  const entries = fs.readdirSync(dirPath, { withFileTypes: true });
  return entries.flatMap(entry => {
    const absolutePath = path.join(dirPath, entry.name);
    if (entry.isDirectory()) return collectDatasetFiles(absolutePath);
    if (entry.isFile() && entry.name.endsWith('-data.js')) return [absolutePath];
    return [];
  });
}

function toRelativeManifestPath(filePath) {
  const rootDir = path.join(MOVEMENTS_DIR, '..');
  const relative = path.relative(rootDir, filePath).replace(/\\/g, '/');
  return `./${relative}`;
}

function getDatasetFiles() {
  return collectDatasetFiles(MOVEMENTS_DIR)
    .map(toRelativeManifestPath)
    .sort();
}

function buildManifestContent(files) {
  const fileList = files.map(f => `    ${JSON.stringify(f)}`).join(',\n');

  return `(function () {
  // Auto-generated by scripts/generate-movement-manifest.js. Do not edit by hand.
  const movementDataFiles = [\n${fileList}\n  ];

  function escapeHtml(value) {
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function showFatalBanner(title, details) {
    try {
      const el = document.createElement('div');
      el.id = 'movement-data-fatal-banner';
      el.setAttribute(
        'style',
        [
          'position:fixed',
          'top:0',
          'left:0',
          'right:0',
          'max-height:60vh',
          'overflow:auto',
          'background:#b00020',
          'color:#fff',
          'padding:14px 16px',
          'z-index:2147483647',
          'font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif',
          'box-shadow:0 2px 12px rgba(0,0,0,0.35)'
        ].join(';')
      );

      el.innerHTML =
        '<div style="font-weight:700;font-size:16px;margin-bottom:8px;">' +
        escapeHtml(title) +
        '</div>' +
        '<pre style="margin:0;white-space:pre-wrap;font-size:12px;line-height:1.35;">' +
        escapeHtml(details) +
        '</pre>';

      (document.body || document.documentElement).appendChild(el);
    } catch (e) {
      console.error(title);
      console.error(details);
    }
  }

  if (typeof window !== 'undefined') {
    window.movementDataFiles = movementDataFiles;

    const state = {
      expected: movementDataFiles.slice(),
      pushedBySrc: {},
      errors: []
    };

    window.__movementDataLoadState = state;
    window.__showMovementDataFatalBanner = showFatalBanner;

    window.__movementDataReportError = function (err) {
      state.errors.push(err);
      console.error('[movement-data]', err);
    };

    window.addEventListener(
      'error',
      function (event) {
        try {
          const filename = event && event.filename ? String(event.filename) : '';
          const isDataset =
            filename.includes('/movements/') && filename.endsWith('-data.js');

          if (isDataset) {
            window.__movementDataReportError({
              type: 'runtime',
              src: filename,
              message: event.message,
              lineno: event.lineno,
              colno: event.colno
            });
          }
        } catch (e) {}
      },
      true
    );

    window.movementDatasets = Array.isArray(window.movementDatasets)
      ? window.movementDatasets
      : [];

    (function instrumentDatasetPush() {
      const datasets = window.movementDatasets;
      const originalPush = datasets.push;

      datasets.push = function () {
        const src = window.__movementDataCurrentSrc || 'unknown';
        state.pushedBySrc[src] = (state.pushedBySrc[src] || 0) + arguments.length;
        return originalPush.apply(datasets, arguments);
      };
    })();

    window.__movementDataScriptError = function (src) {
      window.__movementDataReportError({ type: 'load', src: src });
    };

    window.__movementDataFinalizeOrThrow = function () {
      const expected = state.expected;
      const pushed = state.pushedBySrc;
      const errors = state.errors;

      const missing = expected.filter(src => !pushed[src]);
      const multiple = expected.filter(src => (pushed[src] || 0) > 1);
      const unknown = Object.keys(pushed).filter(src => expected.indexOf(src) === -1);

      if (errors.length || missing.length || multiple.length || unknown.length) {
        const lines = [];
        lines.push('Movement datasets failed to load.');
        lines.push('');

        if (errors.length) {
          lines.push('Errors:');
          errors.forEach((e, i) => {
            lines.push(
              '  ' +
                (i + 1) +
                '. [' +
                e.type +
                '] ' +
                (e.src || 'unknown') +
                (e.message ? ': ' + e.message : '')
            );
          });
          lines.push('');
        }

        if (missing.length) {
          lines.push('No dataset registered from these files:');
          missing.forEach(src => lines.push('  - ' + src));
          lines.push('');
        }

        if (multiple.length) {
          lines.push('Multiple datasets registered from these files (expected exactly 1):');
          multiple.forEach(src => lines.push('  - ' + src + ' (count=' + pushed[src] + ')'));
          lines.push('');
        }

        if (unknown.length) {
          lines.push('Datasets registered while "current src" was unknown/unexpected:');
          unknown.forEach(src => lines.push('  - ' + src + ' (count=' + pushed[src] + ')'));
          lines.push('');
        }

        const details = lines.join('\\n');
        showFatalBanner('Reknit failed to boot (movement data)', details);
        throw new Error(details);
      }
    };

    movementDataFiles.forEach(src => {
      document.write('<script>window.__movementDataCurrentSrc=' + JSON.stringify(src) + ';</' + 'script>');
      document.write(
        '<script src="' +
          src +
          '" data-movement-dataset="true" onerror="window.__movementDataScriptError(this.getAttribute(\\'src\\'))"></' +
          'script>'
      );
    });

    document.write('<script>window.__movementDataFinalizeOrThrow();</' + 'script>');
  } else if (typeof module !== 'undefined') {
    module.exports = movementDataFiles;
  }
})();
`;
}

function writeManifest(content) {
  fs.writeFileSync(OUTPUT_FILE, content);
  console.log(`Updated manifest with movement datasets at ${OUTPUT_FILE}`);
}

function main() {
  const files = getDatasetFiles();
  if (files.length === 0) {
    console.error('No movement data files found; manifest not updated.');
    process.exit(1);
  }
  const content = buildManifestContent(files);
  writeManifest(content);
}

if (require.main === module) {
  main();
}
