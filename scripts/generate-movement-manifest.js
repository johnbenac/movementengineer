#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

const MOVEMENTS_DIR = path.join(__dirname, '..', 'movements');
const OUTPUT_FILE = path.join(MOVEMENTS_DIR, 'manifest.js');

function findDatasetFiles(dir) {
  const entries = fs.readdirSync(dir, { withFileTypes: true });
  const files = entries.flatMap(entry => {
    const fullPath = path.join(dir, entry.name);
    if (entry.isDirectory()) {
      return findDatasetFiles(fullPath);
    }
    return entry.isFile() && entry.name.endsWith('-data.js') ? [fullPath] : [];
  });

  return files;
}

function getDatasetFiles() {
  const files = findDatasetFiles(MOVEMENTS_DIR).sort();
  const rootDir = path.join(__dirname, '..');
  return files.map(file => {
    const relative = path.relative(rootDir, file).split(path.sep).join('/');
    return `./${relative}`;
  });
}

function buildManifestContent(files) {
  const fileList = files.map(f => `    '${f}'`).join(',\n');
  return `(function () {
  // Auto-generated by scripts/generate-movement-manifest.js. Do not edit by hand.
  const movementDataFiles = [\n${fileList}\n  ];

  if (typeof window !== 'undefined') {
    window.movementDataFiles = movementDataFiles;
    movementDataFiles.forEach(src => {
      // document.write keeps loading synchronous relative to this script tag,
      // ensuring movement datasets are available before movement-data.js runs.
      document.write('<script src="' + src + '"></' + 'script>');
    });
  } else if (typeof module !== 'undefined') {
    module.exports = movementDataFiles;
  }
})();
`;
}

function writeManifest(content) {
  fs.writeFileSync(OUTPUT_FILE, content);
  console.log(`Updated manifest with movement datasets at ${OUTPUT_FILE}`);
}

function main() {
  const files = getDatasetFiles();
  if (files.length === 0) {
    console.error('No movement data files found; manifest not updated.');
    process.exit(1);
  }
  const content = buildManifestContent(files);
  writeManifest(content);
}

if (require.main === module) {
  main();
}
