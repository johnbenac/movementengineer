<!DOCTYPE html>
<html lang="en" data-me-mode="module">
<head>
  <meta charset="UTF-8" />
  <title>Movement Engineer v3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles.css" />
  <script src="./scripts/marked.min.js"></script>
  <script src="./scripts/dompurify.min.js"></script>
  <script src="./scripts/js-yaml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
  <body>
    <header class="top-bar">
      <div class="top-bar-left">
        <button
          id="btn-toggle-sidebar"
          class="sidebar-toggle"
          aria-label="Toggle movement list"
          aria-controls="movement-sidebar"
          aria-expanded="false"
          type="button"
        >
          ☰
        </button>
        <div class="top-bar-title">
          <h1>Movement Engineer v3</h1>
          <span class="schema-version">Spec v2.3</span>
        </div>
      </div>
      <div class="top-bar-right">
        <button id="btn-reset-defaults" title="Clear all data and reload the default movement">
          Clear & reset
        </button>
        <a
          class="icon-button"
          href="https://github.com/johnbenac/movementengineer"
          target="_blank"
          rel="noopener noreferrer"
          aria-label="View Movement Engineer on GitHub"
        >
          <svg aria-hidden="true" viewBox="0 0 24 24">
            <path
              fill="currentColor"
              d="M12 .5C5.65.5.5 5.65.5 12c0 5.1 3.3 9.4 7.9 10.9.6.1.8-.2.8-.5v-2.1c-3.2.7-3.9-1.4-3.9-1.4-.5-1.2-1.1-1.6-1.1-1.6-.9-.6.1-.6.1-.6 1 .1 1.6 1.1 1.6 1.1.9 1.6 2.5 1.1 3.1.8.1-.6.4-1.1.7-1.3-2.6-.3-5.4-1.3-5.4-5.8 0-1.3.5-2.3 1.1-3.1-.1-.3-.5-1.5.1-3.1 0 0 1-.3 3.2 1.1a11 11 0 0 1 5.8 0c2.2-1.4 3.2-1.1 3.2-1.1.6 1.6.2 2.8.1 3.1.7.8 1.1 1.9 1.1 3.1 0 4.6-2.8 5.5-5.4 5.8.4.3.8 1 .8 2.1v3.1c0 .3.2.6.8.5A10.8 10.8 0 0 0 23.5 12C23.5 5.65 18.35.5 12 .5Z"
            />
          </svg>
        </a>
        <span id="status" class="status"></span>
      </div>
    </header>

    <div id="save-banner" class="save-banner">
      <span id="save-banner-text"></span>
      <button id="btn-save-banner" type="button">Save changes</button>
    </div>

    <main class="layout">
      <aside id="movement-sidebar" class="sidebar">
        <div class="sidebar-header">
          <h2>Movements</h2>
          <button id="btn-add-movement" title="Create a new movement">+</button>
        </div>
        <ul id="movement-list" class="item-list"></ul>
      </aside>

      <div id="sidebar-scrim" class="sidebar-scrim" aria-hidden="true"></div>

      <section class="content">
      <nav class="tabs">
        <button class="tab active" data-tab="dashboard">Dashboard</button>
        <button class="tab" data-tab="canon">Library</button>
        <button class="tab" data-tab="entities">Entities</button>
        <button class="tab" data-tab="practices">Practices</button>
        <button class="tab" data-tab="calendar">Calendar</button>
        <button class="tab" data-tab="claims">Claims</button>
        <button class="tab" data-tab="rules">Rules</button>
        <button class="tab" data-tab="authority">Authority</button>
        <button class="tab" data-tab="media">Media</button>
        <button class="tab" data-tab="graph">Graph</button>
        <button class="tab" data-tab="notes">Notes</button>
        <button class="tab" data-tab="collections">Collections</button>
        <button class="tab" data-tab="comparison">Comparison</button>
      </nav>

      <!-- Dashboard tab -->
      <section id="tab-dashboard" class="tab-panel active">
        <div class="panel-body">
          <div class="dashboard-grid">
            <section class="card movement-form-card">
              <h2>Movement details</h2>
              <p class="hint">
                Choose a movement in the sidebar, then edit its core fields here.
              </p>
              <form id="movement-form" autocomplete="off">
                <div class="form-row">
                  <label>ID</label>
                  <span id="movement-id-label" class="code-pill">—</span>
                </div>

                <div class="form-row">
                  <label for="movement-name">Name</label>
                  <input id="movement-name" type="text" required />
                </div>

                <div class="form-row">
                  <label for="movement-shortName">Short name</label>
                  <input id="movement-shortName" type="text" />
                </div>

                <div class="form-row">
                  <label for="movement-summary">Summary</label>
                  <textarea id="movement-summary" rows="4"></textarea>
                </div>

                <div class="form-row">
                  <label for="movement-tags">Tags (comma‑separated)</label>
                  <input id="movement-tags" type="text" placeholder="test, upside, etc." />
                </div>

                <div class="form-actions">
                  <button id="btn-save-movement" type="button">Save movement</button>
                  <button id="btn-import-from-github" type="button">
                    Load markdown repo
                  </button>
                  <button id="btn-export-repo" type="button">
                    Export markdown zip
                  </button>
                  <button id="btn-delete-movement" type="button" class="danger">
                    Delete movement & related data
                  </button>
                </div>
              </form>
            </section>

            <section class="card">
              <div id="dashboard-content"></div>
            </section>
          </div>
        </div>
      </section>

      <!-- Library / Canon -->
      <section id="tab-canon" class="tab-panel">
        <div class="panel-body library-atmosphere">
          <h2>Library</h2>
          <p class="hint">Shelves → books → table of contents.</p>
          <div class="library-layout">
            <div class="library-pane shelves-pane">
              <div class="pane-header">
                <div>
                  <div class="section-heading small">Shelves</div>
                  <p class="muted" id="shelf-hint">Choose a shelf to browse its books.</p>
                </div>
                <div class="inline-actions">
                  <button id="btn-add-text-collection" type="button">New shelf</button>
                </div>
              </div>
              <div class="input-row">
                <input
                  id="library-search"
                  type="search"
                  placeholder="Search shelves, books, chapters"
                />
              </div>
              <ul id="library-search-results" class="library-search-results"></ul>
              <div id="shelf-list" class="shelf-list"></div>
              <div class="section-heading small">Un-shelved books</div>
              <div id="unshelved-list" class="shelf-list muted"></div>
            </div>

            <div class="library-pane books-pane">
              <div class="pane-header">
                <div>
                  <div class="section-heading small" id="books-pane-title">Books</div>
                  <p class="muted" id="books-pane-hint">Pick a shelf to see its books.</p>
                </div>
                <div class="inline-actions">
                  <button id="btn-add-root-text" type="button">Add new book</button>
                  <button id="btn-add-existing-book" type="button">Add existing book</button>
                </div>
              </div>
              <div id="book-list" class="book-list"></div>
              <div class="section-heading small">Table of contents</div>
              <div id="toc-tree" class="tree-container"></div>
            </div>

            <div class="library-pane editor-pane">
              <div class="pane-header">
                <div class="section-heading small">Editor</div>
                <div class="breadcrumb" id="library-breadcrumb"></div>
              </div>
              <div class="card" id="shelf-editor"></div>
              <div class="card" id="text-editor"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Entities -->
      <section id="tab-entities" class="tab-panel">
        <div class="panel-body">
          <h2>Entities</h2>
          <p class="hint">
            Explore entities and their relationships within the movement.
          </p>
          <div class="subtab-toolbar">
            <label>
              Entity:
              <select id="entity-select"></select>
            </label>
          </div>
          <div id="entity-detail" class="detail-section"></div>

          <div class="section-heading small">Relation graph (list view)</div>
          <div class="subtab-toolbar">
            <label>
              Depth:
              <select id="entity-graph-depth">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
            </label>
            <label class="grow">
              Relation types (comma‑separated, optional):
              <input
                id="entity-graph-relation-types"
                type="text"
                placeholder="mother_of, part_of, instance_of"
              />
            </label>
            <button id="btn-refresh-entity-graph" type="button">Refresh graph</button>
          </div>
          <div id="entity-graph" class="detail-section"></div>
        </div>
      </section>

      <!-- Practices -->
      <section id="tab-practices" class="tab-panel">
        <div class="panel-body">
          <h2>Practices</h2>
          <p class="hint">Review and inspect practices tied to the movement.</p>
          <div class="subtab-toolbar">
            <label>
              Practice:
              <select id="practice-select"></select>
            </label>
          </div>
          <div id="practice-detail" class="detail-section"></div>
        </div>
      </section>

      <!-- Calendar -->
      <section id="tab-calendar" class="tab-panel">
        <div class="panel-body">
          <h2>Calendar</h2>
          <p class="hint">
            Filter and browse recurring events for the selected movement.
          </p>
          <div class="subtab-toolbar">
            <label>
              Recurrence:
              <select id="calendar-recurrence-filter">
                <option value="">All</option>
                <option value="once">once</option>
                <option value="daily">daily</option>
                <option value="weekly">weekly</option>
                <option value="monthly">monthly</option>
                <option value="yearly">yearly</option>
                <option value="other">other</option>
              </select>
            </label>
          </div>
          <div id="calendar-view" class="card-grid"></div>
        </div>
      </section>

      <!-- Claims -->
      <section id="tab-claims" class="tab-panel">
        <div class="panel-body">
          <h2>Claims</h2>
          <p class="hint">
            Inspect claims by category or entity context for the movement.
          </p>
          <div class="subtab-toolbar">
            <label>
              Category:
              <select id="claims-category-filter">
                <option value="">All</option>
              </select>
            </label>
            <label>
              About entity:
              <select id="claims-entity-filter">
                <option value="">Any</option>
              </select>
            </label>
            <div class="toolbar-actions">
              <button id="claims-add-btn" type="button">New claim</button>
              <button id="claims-delete-btn" type="button" class="danger" disabled>
                Delete
              </button>
            </div>
          </div>
          <div class="split">
            <div class="list-pane">
              <div id="claims-table-wrapper" class="table-wrapper"></div>
            </div>
            <div class="detail-pane">
              <form id="claim-editor-form" class="card" autocomplete="off">
                <div class="section-heading small">Claim editor</div>

                <div class="form-row">
                  <label for="claim-id">ID</label>
                  <input id="claim-id" type="text" readonly />
                </div>

                <div class="form-row">
                  <label for="claim-category">Category</label>
                  <input id="claim-category" type="text" list="claim-category-options" />
                  <datalist id="claim-category-options"></datalist>
                </div>

                <div class="form-row">
                  <label for="claim-text">Text</label>
                  <textarea id="claim-text" rows="3"></textarea>
                </div>

                <div class="form-row">
                  <label for="claim-tags">Tags (comma‑separated)</label>
                  <input id="claim-tags" type="text" list="claim-tag-options" />
                  <datalist id="claim-tag-options"></datalist>
                </div>

                <div class="form-row">
                  <label for="claim-entities">About entities</label>
                  <select id="claim-entities" multiple></select>
                </div>

                <div class="form-row">
                  <label for="claim-source-texts">Source texts</label>
                  <select id="claim-source-texts" multiple></select>
                </div>

                <div class="form-row">
                  <label for="claim-source-entities">Source entities</label>
                  <select id="claim-source-entities" multiple></select>
                </div>

                <div class="form-row">
                  <label for="claim-sources-of-truth">Sources of truth (comma‑separated)</label>
                  <input
                    id="claim-sources-of-truth"
                    type="text"
                    list="claim-source-of-truth-options"
                  />
                  <datalist id="claim-source-of-truth-options"></datalist>
                </div>

                <div class="form-row">
                  <label for="claim-notes">Notes</label>
                  <textarea id="claim-notes" rows="2"></textarea>
                </div>

                <div class="form-actions">
                  <button id="claims-save-btn" type="button">Save claim</button>
                  <button id="claims-reset-btn" type="button">Reset</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>

      <!-- Rules -->
      <section id="tab-rules" class="tab-panel">
        <div class="panel-body">
          <h2>Rules</h2>
          <p class="hint">Filter rules by kind or domain to understand obligations and ideals.</p>

          <div class="rules-layout">
            <div class="rules-pane rules-browser card">
              <div class="card-header">
                <div>
                  <div class="eyebrow">Browse</div>
                  <h3 class="card-title">Rules overview</h3>
                  <p class="muted small-text">
                    Use the filters to focus the table, then select a rule to review or edit.
                  </p>
                </div>
              </div>

              <div class="rules-filter-grid">
                <label>
                  Kind
                  <select id="rules-kind-filter">
                    <option value="">All</option>
                    <option value="must_do">must_do</option>
                    <option value="must_not_do">must_not_do</option>
                    <option value="should_do">should_do</option>
                    <option value="ideal">ideal</option>
                  </select>
                </label>
                <label class="grow">
                  Domain filter (comma‑separated)
                  <input
                    id="rules-domain-filter"
                    type="text"
                    placeholder="worship, diet, penance"
                  />
                </label>
              </div>

              <div id="rules-table-wrapper" class="table-wrapper"></div>
            </div>

            <div class="rules-pane">
              <div id="rules-editor" class="card rules-editor-card">
                <div class="card-header">
                  <div>
                    <div class="eyebrow">Edit</div>
                    <h3 class="card-title">Rule details</h3>
                    <p class="muted small-text">
                      Keep the short summary clear, then link supporting texts, claims, and sources.
                    </p>
                  </div>
                  <div class="button-group">
                    <button id="rules-add-btn" type="button">Add rule</button>
                    <button id="rules-delete-btn" type="button" class="danger">Delete rule</button>
                  </div>
                </div>

                <div class="rules-editor-top">
                  <div class="form-row">
                    <label for="rules-editor-select">Select rule</label>
                    <select id="rules-editor-select"></select>
                  </div>
                </div>

                <div class="rules-editor-grid">
                  <div class="form-row">
                    <label for="rules-editor-shortText">Short text</label>
                    <input id="rules-editor-shortText" type="text" />
                  </div>
                  <div class="form-row">
                    <label for="rules-editor-kind">Kind</label>
                    <select id="rules-editor-kind"></select>
                  </div>
                  <div class="form-row wide">
                    <label for="rules-editor-details">Details</label>
                    <textarea id="rules-editor-details" rows="3"></textarea>
                  </div>
                  <div class="form-row">
                    <label for="rules-editor-appliesTo">Applies to (comma-separated)</label>
                    <input
                      id="rules-editor-appliesTo"
                      type="text"
                      list="rules-applies-suggestions"
                      placeholder="everyone, clergy, laity"
                    />
                    <datalist id="rules-applies-suggestions"></datalist>
                  </div>
                  <div class="form-row">
                    <label for="rules-editor-domain">Domain (comma-separated)</label>
                    <input
                      id="rules-editor-domain"
                      type="text"
                      list="rules-domain-suggestions"
                      placeholder="worship, diet, ethics"
                    />
                    <datalist id="rules-domain-suggestions"></datalist>
                  </div>
                  <div class="form-row">
                    <label for="rules-editor-tags">Tags (comma-separated)</label>
                    <input id="rules-editor-tags" type="text" list="rules-tags-suggestions" />
                    <datalist id="rules-tags-suggestions"></datalist>
                  </div>
                  <div class="form-row wide">
                    <label for="rules-editor-supporting-texts">Supporting texts</label>
                    <select id="rules-editor-supporting-texts" multiple></select>
                  </div>
                  <div class="form-row wide">
                    <label for="rules-editor-supporting-claims">Supporting claims</label>
                    <select id="rules-editor-supporting-claims" multiple></select>
                  </div>
                  <div class="form-row wide">
                    <label for="rules-editor-related-practices">Related practices</label>
                    <select id="rules-editor-related-practices" multiple></select>
                  </div>
                  <div class="form-row wide">
                    <label for="rules-editor-source-entities">Source entities</label>
                    <select id="rules-editor-source-entities" multiple></select>
                  </div>
                  <div class="form-row">
                    <label for="rules-editor-sourcesOfTruth">Sources of truth (comma-separated)</label>
                    <input
                      id="rules-editor-sourcesOfTruth"
                      type="text"
                      list="rules-sources-suggestions"
                      placeholder="scripture, council, tradition"
                    />
                    <datalist id="rules-sources-suggestions"></datalist>
                  </div>
                </div>

                <div class="form-actions">
                  <button id="rules-save-btn" type="button">Save rule</button>
                  <span class="hint small" id="rules-editor-helper">
                    Select or add a rule to edit links and details.
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Authority -->
      <section id="tab-authority" class="tab-panel">
        <div class="panel-body">
          <h2>Authority</h2>
          <p class="hint">View sources of truth and authority entities for the movement.</p>
          <div class="section-heading">Sources of truth</div>
          <div id="authority-sources" class="card-grid"></div>

          <div class="section-heading">Authority entities</div>
          <div id="authority-entities" class="card-grid"></div>
        </div>
      </section>

      <!-- Media -->
      <section id="tab-media" class="tab-panel">
        <div class="panel-body">
          <h2>Media</h2>
          <p class="hint">
            Filter media artifacts by related entities, practices, events, or texts.
          </p>
          <div class="subtab-toolbar">
            <label>
              Entity:
              <select id="media-entity-filter">
                <option value="">Any</option>
              </select>
            </label>
            <label>
              Practice:
              <select id="media-practice-filter">
                <option value="">Any</option>
              </select>
            </label>
            <label>
              Event:
              <select id="media-event-filter">
                <option value="">Any</option>
              </select>
            </label>
            <label>
              Text:
              <select id="media-text-filter">
                <option value="">Any</option>
              </select>
            </label>
          </div>
          <div id="media-gallery" class="card-grid"></div>
        </div>
      </section>

      <!-- Graph -->
      <section id="tab-graph" class="tab-panel">
        <div class="panel-body">
          <div id="graph-workbench-root"></div>
        </div>
      </section>

      <!-- Notes -->
      <section id="tab-notes" class="tab-panel">
        <div class="panel-body">
          <h2>Notes</h2>
          <p class="hint">
            Browse notes by target type and target within the movement. Add new notes or edit existing
            ones on the right.
          </p>
          <div class="split">
            <div class="list-pane">
              <div class="subtab-toolbar">
                <label>
                  Target type:
                  <select id="notes-target-type-filter">
                    <option value="">All</option>
                  </select>
                </label>
                <label>
                  Target:
                  <select id="notes-target-id-filter">
                    <option value="">Any</option>
                  </select>
                </label>
              </div>
              <div id="notes-table-wrapper" class="table-wrapper"></div>
            </div>
            <div class="detail-pane">
              <div class="card">
                <h3 id="notes-form-title">Create note</h3>
                <form id="notes-editor-form" class="graph-form">
                  <div class="form-row">
                    <label>Target type</label>
                    <select id="note-target-type" required></select>
                  </div>
                  <div class="form-row">
                    <label>Target ID</label>
                    <input id="note-target-id" type="text" list="notes-target-id-options" required />
                    <datalist id="notes-target-id-options"></datalist>
                    <div class="hint">Pick from suggestions or paste any valid ID.</div>
                  </div>
                  <div class="form-row">
                    <label>Author</label>
                    <input id="note-author" type="text" />
                  </div>
                  <div class="form-row">
                    <label>Body</label>
                    <textarea id="note-body" rows="3" required></textarea>
                  </div>
                  <div class="form-row">
                    <label>Context</label>
                    <textarea id="note-context" rows="2"></textarea>
                  </div>
                  <div class="form-row">
                    <label>Tags (comma separated)</label>
                    <input id="note-tags" type="text" placeholder="tag1, tag2" />
                  </div>
                  <div class="form-row inline">
                    <button type="submit">Save note</button>
                    <button id="note-reset-btn" type="button">New note</button>
                    <button id="note-delete-btn" type="button" class="danger" disabled>Delete</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </section>
      <!-- Generic collection editor -->
      <section id="tab-collections" class="tab-panel">
        <div class="panel-body">
          <h2>Collections</h2>
          <p class="hint">
            Edit any collection as JSON. For movement‑scoped collections, you can filter by the
            currently selected movement.
          </p>

          <div class="collection-toolbar">
            <label>
              Collection:
              <select id="collection-select">
                <option value="entities">entities</option>
                <option value="practices">practices</option>
                <option value="events">events</option>
                <option value="rules">rules</option>
                <option value="claims">claims</option>
                <option value="textCollections">textCollections</option>
                <option value="texts">texts</option>
                <option value="media">media</option>
                <option value="notes">notes</option>
              </select>
            </label>

            <label class="inline">
              <input id="collection-filter-by-movement" type="checkbox" checked />
              Filter by current movement
            </label>

            <div class="collection-actions">
              <button id="btn-add-item" type="button">New item</button>
              <button id="btn-delete-item" type="button" class="danger" disabled>
                Delete item
              </button>
            </div>
          </div>

          <div class="split">
            <div class="list-pane">
              <ul id="collection-items" class="item-list"></ul>
            </div>
            <div class="detail-pane">
              <div class="item-detail-grid">
                <section class="preview-pane">
                  <div class="preview-header">
                    <div>
                      <div class="eyebrow">Human-readable view</div>
                      <h3 id="item-preview-title">Select an item</h3>
                      <div id="item-preview-subtitle" class="muted"></div>
                    </div>
                    <div class="preview-meta">
                      <div class="preview-nav">
                        <button id="btn-preview-back" type="button" title="Back" disabled>
                          ←
                        </button>
                        <button
                          id="btn-preview-forward"
                          type="button"
                          title="Forward"
                          disabled
                        >
                          →
                        </button>
                      </div>
                      <div class="badge" id="item-preview-collection">—</div>
                    </div>
                  </div>
                  <div id="item-preview-body" class="preview-body"></div>
                </section>

                <section class="editor-pane">
                  <div class="preview-header">
                    <div>
                      <div class="eyebrow">Raw JSON</div>
                      <h3>Machine view</h3>
                      <div class="muted">Edit and save changes</div>
                    </div>
                  </div>
                  <textarea
                    id="item-editor"
                    rows="20"
                    spellcheck="false"
                    placeholder="{ ... }"
                  ></textarea>
                  <div class="editor-actions">
                    <button id="btn-save-item" type="button">Save item</button>
                  </div>
                </section>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Comparison tab -->
      <section id="tab-comparison" class="tab-panel">
        <div class="panel-body">
          <h2>Comparison</h2>
          <p class="hint">
            Pick movements to compare. The table uses
            <code>buildComparisonViewModel</code> under the hood.
          </p>

          <div id="comparison-selector" class="comparison-selector"></div>
          <div id="comparison-table-wrapper" class="comparison-table-wrapper"></div>
        </div>
      </section>
  </section>
  </main>

  <!-- Domain / view-model layers -->
  <script src="./view-models.js"></script>
  <script src="./markdown-dataset-loader.js"></script>
  <script src="./storage.js"></script>
  <script src="./domain-service.js"></script>
  <script src="./graph-colors.js"></script>
  <script src="./graph-view.js"></script>
  <script src="./scripts/d3.min.js"></script>
  <!-- comparison-services.js is not required for this UI, but harmless to include if you like -->
  <!-- <script src="./comparison-services.js"></script> -->

  <script type="module" src="./src/app/main.js"></script>
</body>
</html>
